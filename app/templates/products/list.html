{% extends "base.html" %}

{% block title %}Products - Laser OS{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <nav class="breadcrumb">
            <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
            <span>/</span>
            <span>Products</span>
        </nav>
        <h1>Products</h1>
    </div>
    <div>
        {% if current_user.has_role('admin') or current_user.has_role('manager') %}
        <a href="{{ url_for('products.new_product') }}" class="btn btn-primary">+ New Product</a>
        {% endif %}
    </div>
</div>

<!-- Search and Filters -->
<div class="card">
    <div class="card-body">
        <form method="GET" action="{{ url_for('products.index') }}" class="search-form">
            <div class="grid grid-2 grid-gap-md">
                <div class="form-group form-group-no-margin">
                    <label for="search">Search:</label>
                    <input
                        type="text"
                        id="search"
                        name="search"
                        class="form-control"
                        placeholder="Search products by name, SKU, or description"
                        value="{{ search }}"
                    >
                </div>
                <div class="form-group form-group-no-margin">
                    <label for="material">Material:</label>
                    <select id="material" name="material" class="form-control">
                        <option value="">All Materials</option>
                        {% for material in materials %}
                        <option value="{{ material }}" {% if material_filter == material %}selected{% endif %}>
                            {{ material }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="mt-md flex-row flex-gap-sm">
                <button type="submit" class="btn btn-primary">Apply Filters</button>
                <a href="{{ url_for('products.index') }}" class="btn btn-secondary">Clear Filters</a>
            </div>
        </form>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-header">
        <h2>All Products ({{ pagination.total }})</h2>
    </div>
    
    {% if products %}
    <table class="table">
        <thead>
            <tr>
                <th>SKU Code</th>
                <th>Name</th>
                <th>Material</th>
                <th>Thickness</th>
                <th>Unit Price</th>
                <th>Files</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in products %}
            <tr>
                <td>
                    <a href="{{ url_for('products.detail', id=product.id) }}" class="link">
                        {{ product.sku_code }}
                    </a>
                </td>
                <td>
                    <strong>{{ product.name }}</strong>
                    {% if product.description %}
                    <br><small class="text-muted">{{ product.description[:100] }}{% if product.description|length > 100 %}...{% endif %}</small>
                    {% endif %}
                </td>
                <td>{{ product.material or '-' }}</td>
                <td>
                    {% if product.thickness %}
                        {{ product.thickness }}mm
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if product.unit_price %}
                        R{{ "%.2f"|format(product.unit_price) }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if product.product_files|length > 0 %}
                        <span class="badge badge-info">{{ product.product_files|length }} file(s)</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>
                <td>{{ product.created_at|date }}</td>
                <td>
                    <div class="btn-group">
                        <a href="{{ url_for('products.detail', id=product.id) }}" class="btn btn-sm btn-secondary">View</a>
                        {% if current_user.has_role('admin') or current_user.has_role('manager') %}
                        <a href="{{ url_for('products.edit', id=product.id) }}" class="btn btn-sm btn-primary">Edit</a>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <!-- Pagination -->
    {% if pagination.pages > 1 %}
    <div class="pagination">
        {% if pagination.has_prev %}
        <a href="{{ url_for('products.index', page=pagination.prev_num, search=search, material=material_filter) }}" class="btn btn-ghost">&laquo; Previous</a>
        {% endif %}

        <span class="pagination-info">
            Page {{ pagination.page }} of {{ pagination.pages }}
        </span>

        {% if pagination.has_next %}
        <a href="{{ url_for('products.index', page=pagination.next_num, search=search, material=material_filter) }}" class="btn btn-ghost">Next &raquo;</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <p>No products found.</p>
        {% if search or material_filter %}
            <p>Try adjusting your search or filter criteria.</p>
        {% else %}
            <p>Get started by creating your first product.</p>
            {% if current_user.has_role('admin') or current_user.has_role('manager') %}
            <a href="{{ url_for('products.new_product') }}" class="btn btn-primary">+ New Product</a>
            {% endif %}
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

