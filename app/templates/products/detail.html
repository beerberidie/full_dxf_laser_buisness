{% extends "base.html" %}

{% block title %}{{ product.sku_code }} - Laser OS{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <nav class="breadcrumb">
            <a href="{{ url_for('main.dashboard') }}">Dashboard</a>
            <span>/</span>
            <a href="{{ url_for('products.index') }}">Products</a>
            <span>/</span>
            <span>{{ product.sku_code }}</span>
        </nav>
        <h1>{{ product.name }}</h1>
        <p class="text-muted">SKU: {{ product.sku_code }}</p>
    </div>
    <div>
        {% if current_user.has_role('admin') or current_user.has_role('manager') %}
        <a href="{{ url_for('products.edit', id=product.id) }}" class="btn btn-primary">Edit Product</a>
        <form method="POST" action="{{ url_for('products.delete', id=product.id) }}" class="inline-form" onsubmit="return confirm('Are you sure you want to delete this product?');">
            <button type="submit" class="btn btn-danger">Delete Product</button>
        </form>
        {% endif %}
    </div>
</div>

<div class="grid grid-2">
    <!-- Product Information -->
    <div class="card">
        <div class="card-header">
            <h2>Product Information</h2>
        </div>
        <div class="card-body">
            <dl class="detail-list">
                <dt>SKU Code</dt>
                <dd>{{ product.sku_code }}</dd>

                <dt>Name</dt>
                <dd>{{ product.name }}</dd>

                {% if product.description %}
                <dt>Description</dt>
                <dd>{{ product.description }}</dd>
                {% endif %}

                <dt>Material</dt>
                <dd>{{ product.material or '-' }}</dd>

                <dt>Thickness</dt>
                <dd>
                    {% if product.thickness %}
                        {{ product.thickness }}mm
                    {% else %}
                        -
                    {% endif %}
                </dd>

                <dt>Unit Price</dt>
                <dd>
                    {% if product.unit_price %}
                        R{{ "%.2f"|format(product.unit_price) }}
                    {% else %}
                        -
                    {% endif %}
                </dd>

                {% if product.notes %}
                <dt>Notes</dt>
                <dd>{{ product.notes }}</dd>
                {% endif %}
            </dl>
        </div>
    </div>
    
    <!-- Metadata -->
    <div class="card">
        <div class="card-header">
            <h2>Metadata</h2>
        </div>
        <div class="card-body">
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Created:</span>
                    <span class="info-value">{{ product.created_at|datetime }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Last Updated:</span>
                    <span class="info-value">{{ product.updated_at|datetime }}</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Projects Using This Product -->
<div class="card">
    <div class="card-header">
        <h2>Projects Using This Product ({{ project_products|length }})</h2>
    </div>
    {% if project_products %}
    <table class="table">
        <thead>
            <tr>
                <th>Project Code</th>
                <th>Project Name</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total</th>
                <th>Added</th>
            </tr>
        </thead>
        <tbody>
            {% for pp in project_products %}
            <tr>
                <td>
                    {% if pp.project %}
                    <a href="{{ url_for('projects.detail', id=pp.project.id) }}" class="link">
                        {{ pp.project.project_code }}
                    </a>
                    {% else %}
                    <span class="text-muted">[Deleted Project]</span>
                    {% endif %}
                </td>
                <td>{{ pp.project.name if pp.project else '-' }}</td>
                <td>{{ pp.quantity }}</td>
                <td>
                    {% if pp.unit_price %}
                        R{{ "%.2f"|format(pp.unit_price) }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if pp.unit_price %}
                        R{{ "%.2f"|format(pp.total_price) }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>{{ pp.created_at|date }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>This product has not been used in any projects yet.</p>
    </div>
    {% endif %}
</div>

<!-- Product Files -->
<div class="card">
    <div class="card-header">
        <h2>Product Files ({{ product_files|length }})</h2>
        <button type="button" class="btn btn-primary" onclick="toggleUploadForm()">Upload File</button>
    </div>
    <div class="card-body">
        <!-- Upload Form (Hidden by default) -->
        <div id="uploadForm" class="upload-form-container hidden">
            <h3 class="upload-form-title">Upload Design File</h3>
            <form action="{{ url_for('products.upload_file', product_id=product.id) }}" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">Select File(s) (DXF or LightBurn):</label>
                    <input type="file" id="file" name="files" accept=".dxf,.DXF,.lbrn2,.LBRN2" multiple class="form-control" onchange="updateFileCount(this, 'productDetailFileCount')">
                    <small class="text-muted">Accepted: DXF, LBRN2 | Maximum file size: 50 MB each | You can select multiple files</small>
                    <div id="productDetailFileCount" class="text-info mt-1" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label for="notes">Notes (optional):</label>
                    <textarea id="notes" name="notes" class="form-control" rows="2"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Upload</button>
                    <button type="button" class="btn btn-secondary" onclick="toggleUploadForm()">Cancel</button>
                </div>
            </form>
        </div>

        <!-- Files List -->
        {% if product_files %}
        <table class="table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Type</th>
                    <th>Size</th>
                    <th>Uploaded</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for file in product_files %}
                <tr>
                    <td>
                        ðŸ“„ {{ file.original_filename }}
                        {% if file.notes %}
                        <br><small class="text-muted">{{ file.notes }}</small>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge badge-{{ 'info' if file.file_type == 'dxf' else 'success' }}">
                            {{ file.file_type.upper() }}
                        </span>
                    </td>
                    <td>{{ file.file_size_mb }} MB</td>
                    <td>{{ file.upload_date|datetime }}</td>
                    <td>
                        <a href="{{ url_for('products.download_file', file_id=file.id) }}" class="btn btn-sm btn-primary">Download</a>
                        <form action="{{ url_for('products.delete_file', file_id=file.id) }}" method="POST" class="inline-form"
                              onsubmit="return confirm('Delete file {{ file.original_filename }}?');">
                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                        </form>
   </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="text-muted mt-md">
            Total: {{ product_files|length }} file(s)
        </p>
        {% else %}
        <p class="text-muted">No files uploaded yet. Click "Upload File" to add DXF or LightBurn files to this product.</p>
        {% endif %}
    </div>
</div>

<!-- Activity Log -->
<div class="card">
    <div class="card-header">
        <h2>Activity Log</h2>
    </div>
    {% if activity_logs %}
    <table class="table">
        <thead>
            <tr>
                <th>Date/Time</th>
                <th>Action</th>
                <th>User</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody>
            {% for log in activity_logs %}
            <tr>
                <td>{{ log.created_at|datetime }}</td>
                <td><span class="badge badge-{{ log.action.lower() }}">{{ log.action }}</span></td>
                <td>{{ log.user or 'System' }}</td>
                <td>{{ log.details or '-' }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p>No activity logged yet.</p>
    </div>
    {% endif %}
</div>

<script>
function toggleUploadForm() {
    var form = document.getElementById('uploadForm');
    form.classList.toggle('hidden');
}
</script>
{% endblock %}

