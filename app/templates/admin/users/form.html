{% extends "base.html" %}

{% block title %}{{ 'Edit User' if user else 'New User' }} - Laser OS{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ '✏️ Edit User' if user else '➕ New User' }}</h1>
    <div class="page-actions">
        <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">
            ← Back to Users
        </a>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2>{{ 'Edit User: ' + user.username if user else 'Create New User' }}</h2>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('admin.edit_user', id=user.id) if user else url_for('admin.new_user') }}">
            {{ form.hidden_tag() }}
            
            <div class="form-section">
                <h3>Account Information</h3>
                
                <div class="form-group">
                    {{ form.username.label }}
                    {{ form.username(class="form-control") }}
                    {% if form.username.errors %}
                        <div class="error-message">
                            {% for error in form.username.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text">Username must be 3-80 characters, unique in the system.</small>
                </div>
                
                <div class="form-group">
                    {{ form.email.label }}
                    {{ form.email(class="form-control", type="email") }}
                    {% if form.email.errors %}
                        <div class="error-message">
                            {% for error in form.email.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text">Email address must be unique in the system.</small>
                </div>
                
                <div class="form-group">
                    {{ form.full_name.label }}
                    {{ form.full_name(class="form-control") }}
                    {% if form.full_name.errors %}
                        <div class="error-message">
                            {% for error in form.full_name.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text">Optional: User's full name for display purposes.</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>{{ 'Change Password' if user else 'Set Password' }}</h3>
                
                <div class="form-group">
                    {{ form.password.label }}
                    {{ form.password(class="form-control") }}
                    {% if form.password.errors %}
                        <div class="error-message">
                            {% for error in form.password.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text">
                        {% if user %}
                            Leave blank to keep current password. 
                        {% else %}
                            Required for new users. 
                        {% endif %}
                        Must be at least 8 characters with uppercase, lowercase, number, and special character.
                    </small>
                </div>
                
                <div class="form-group">
                    {{ form.confirm_password.label }}
                    {{ form.confirm_password(class="form-control") }}
                    {% if form.confirm_password.errors %}
                        <div class="error-message">
                            {% for error in form.confirm_password.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <div class="form-section">
                <h3>Roles & Permissions</h3>
                
                <div class="form-group">
                    {{ form.roles.label }}
                    <div class="checkbox-group">
                        {% for value, label in form.roles.choices %}
                        <div class="checkbox-item">
                            <input type="checkbox" 
                                   name="roles" 
                                   value="{{ value }}" 
                                   id="role_{{ value }}"
                                   {% if value in form.roles.data %}checked{% endif %}>
                            <label for="role_{{ value }}">{{ label }}</label>
                        </div>
                        {% endfor %}
                    </div>
                    {% if form.roles.errors %}
                        <div class="error-message">
                            {% for error in form.roles.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text">Select one or more roles for this user.</small>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-item">
                        {{ form.is_superuser(id="is_superuser") }}
                        {{ form.is_superuser.label }}
                    </div>
                    {% if form.is_superuser.errors %}
                        <div class="error-message">
                            {% for error in form.is_superuser.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text">⚠️ Superusers have unrestricted access to all system functions.</small>
                </div>
            </div>
            
            <div class="form-section">
                <h3>Account Status</h3>
                
                <div class="form-group">
                    <div class="checkbox-item">
                        {{ form.is_active(id="is_active", checked=True if not user else None) }}
                        {{ form.is_active.label }}
                    </div>
                    {% if form.is_active.errors %}
                        <div class="error-message">
                            {% for error in form.is_active.errors %}
                                <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    <small class="form-text">Inactive accounts cannot log in.</small>
                </div>
            </div>
            
            <div class="form-actions">
                {{ form.submit(class="btn btn-primary") }}
                <a href="{{ url_for('admin.users') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

<style>
.form-section {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section h3 {
    margin-bottom: 15px;
    color: #333;
    font-size: 18px;
}

.checkbox-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-item input[type="checkbox"] {
    width: auto;
    margin: 0;
}

.checkbox-item label {
    margin: 0;
    font-weight: normal;
}

.form-actions {
    margin-top: 30px;
    display: flex;
    gap: 10px;
}
</style>
{% endblock %}

