import React, { useEffect, useState } from 'react'
const LS_KEY='wa_connector_settings_v1'
function useCfg(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{ baseUrl:'http://localhost:8080'} }catch{ return { baseUrl:'http://localhost:8080' }}}
async function jsonFetch(url){ const res=await fetch(url); const text=await res.text(); try{ const data=text?JSON.parse(text):null; if(!res.ok) throw new Error(data?JSON.stringify(data):text); return { ok:true, data }; }catch(err){ return { ok:false, error: err.message }} }
export default function Inbox(){ const cfg=useCfg(); const base=(cfg.baseUrl||'').replace(/\/$/,''); const [items,setItems]=useState([]); const [q,setQ]=useState(''); const [dir,setDir]=useState('all'); const [loading,setLoading]=useState(false); async function load(){ setLoading(true); const url=new URL(`${base}/messages`); if(dir!=='all') url.searchParams.set('direction',dir); if(q) url.searchParams.set('search',q); const r=await jsonFetch(url.toString()); if(r.ok) setItems(r.data); setLoading(false);} useEffect(()=>{ load() },[]) ; return (<div><div className='flex gap-2 mb-3'><select value={dir} onChange={e=>setDir(e.target.value)} className='rounded-xl bg-black/40 border border-white/10 px-3 py-2 text-sm'><option value='all'>All</option><option value='in'>Incoming</option><option value='out'>Outgoing</option></select><input value={q} onChange={e=>setQ(e.target.value)} placeholder='Search...' className='rounded-xl bg-black/40 border border-white/10 px-3 py-2 text-sm'/><button onClick={load} className='rounded-xl px-4 py-2 text-sm border border-white/10 bg-white/10 hover:bg-white/20'>Refresh</button></div><div className='grid grid-cols-1 gap-3'>{loading && <div className='text-sm text-gray-400'>Loading…</div>}{!loading && items.length===0 && <div className='text-sm text-gray-400'>No messages yet.</div>}{items.map(row => (<div key={row.id} className='rounded-2xl bg-gray-900/70 border border-white/10 p-4'><div className='flex items-center justify-between'><div className='text-xs text-gray-400'>{new Date(row.created_at).toLocaleString()}</div><div className='flex items-center gap-2'><span className={`px-2 py-0.5 rounded-lg text-xs ${row.direction==='in'?'bg-sky-500/20 text-sky-200':'bg-emerald-500/20 text-emerald-200'}`}>{row.direction}</span><span className='px-2 py-0.5 rounded-lg text-xs bg-amber-500/20 text-amber-200'>{row.type}</span></div></div><div className='mt-1 text-sm'>{row.body || <i className='text-gray-500'>(no body)</i>}</div><div className='mt-1 text-xs text-gray-400'>{row.contact_name? `${row.contact_name} • `:''}{row.contact_wa_id}</div></div>))}</div></div>) }
