import React, { useEffect, useMemo, useState } from "react";
const LS_KEY = "wa_connector_settings_v1";
function useLocalStorageState(key, initial) { const [state,setState]=useState(()=>{ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):initial;}catch{return initial}}); useEffect(()=>{ try{localStorage.setItem(key, JSON.stringify(state));}catch{} },[key,state]); return [state,setState];}
async function jsonFetch(url, opts = {}, timeoutMs = 12000) { const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(), timeoutMs); try{ const res=await fetch(url,{...opts, signal: ctrl.signal}); const text=await res.text(); let data=null; try{ data=text?JSON.parse(text):null;}catch{ data=text;} if(!res.ok) throw new Error(typeof data==='string'?data:JSON.stringify(data)); return { ok:true, status:res.status, data }; } catch(err){ return { ok:false, status:0, error: err?.message||String(err)} } finally{ clearTimeout(id);} }
function Field({ label, children, help }) { return (<div className="mb-4"><label className="block text-sm font-medium text-gray-200 mb-1">{label}</label>{children}{help&&<p className="mt-1 text-xs text-gray-400">{help}</p>}</div>); }
function Card({ title, children, footer }) { return (<div className="rounded-2xl bg-gray-900/70 border border-white/10 shadow-xl p-5">{title&&<h3 className="text-lg font-semibold mb-4 text-white">{title}</h3>}{children}{footer}</div>);} 
function Button({ children, onClick, type = 'button', disabled }) { return (<button type={type} onClick={onClick} disabled={disabled} className={`inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm font-medium shadow-lg transition-all border border-white/10 bg-white/10 hover:bg-white/20 active:scale-[0.98] ${disabled? 'opacity-60 cursor-not-allowed':''}`}>{children}</button>); }
function Input(props){ return (<input {...props} className={`w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-400 ${props.className||''}`} />) }
function Textarea(props){ return (<textarea {...props} className={`w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-400 min-h-[100px] ${props.className||''}`} />) }
function Badge({ tone = 'ok', children}){ const tones={ ok:'bg-emerald-500/20 text-emerald-200 border-emerald-500/30', warn:'bg-amber-500/20 text-amber-200 border-amber-500/30', err:'bg-rose-500/20 text-rose-200 border-rose-500/30', info:'bg-sky-500/20 text-sky-200 border-sky-500/30'}; return <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs border ${tones[tone]}`}>{children}</span>;}
export default function WhatsAppConnect(){ const [cfg,setCfg]=useLocalStorageState(LS_KEY,{ baseUrl:'http://localhost:8080', phoneNumberId:'', verifyToken:'change-me-verify-token' }); const [busy,setBusy]=useState(false); const [health,setHealth]=useState(null); const [verifyResult,setVerifyResult]=useState(null); const [sendState,setSendState]=useState({ to:'', body:'Hello from WhatsAppConnect ðŸ‘‹' }); const [sendResp,setSendResp]=useState(null); const base=cfg.baseUrl?.replace(/\/$/, ''); async function doHealth(){ setBusy(true); const res=await jsonFetch(`${base}/health`); setHealth(res); setBusy(false);} async function doVerifyProbe(){ setBusy(true); const url=`${base}/whatsapp/webhook?mode=subscribe&verify_token=${encodeURIComponent(cfg.verifyToken)}&challenge=ok`; const res=await jsonFetch(url); setVerifyResult(res); setBusy(false);} async function doSend(){ setBusy(true); const res=await jsonFetch(`${base}/whatsapp/send`,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to: sendState.to, type:'text', text:{ body: sendState.body }})}); setSendResp(res); setBusy(false);} const healthBadge=useMemo(()=>{ if(!health) return <Badge tone='info'>unknown</Badge>; if(health.ok) return <Badge tone='ok'>healthy</Badge>; return <Badge tone='err'>unreachable</Badge>;},[health]); return (<div className="space-y-6"><div className="flex items-center justify-between"><h2 className="text-xl font-semibold">Settings</h2><div className="flex items-center gap-2">{healthBadge}<Button onClick={doHealth} disabled={busy}>Check Health</Button></div></div><Card><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><Field label="Backend Base URL" help="e.g., http://localhost:8080"><Input value={cfg.baseUrl} onChange={e=>setCfg({...cfg, baseUrl: e.target.value})} /></Field><Field label="Phone Number ID (optional)" help="Display only"><Input value={cfg.phoneNumberId} onChange={e=>setCfg({...cfg, phoneNumberId: e.target.value})} /></Field><Field label="Verify Token" help="must match server WA_VERIFY_TOKEN"><Input value={cfg.verifyToken} onChange={e=>setCfg({...cfg, verifyToken: e.target.value})} /></Field></div><div className="mt-3 flex items-center gap-3"><Button onClick={doVerifyProbe} disabled={busy}>Test Webhook Verify</Button>{verifyResult && (verifyResult.ok ? <Badge tone='ok'>verified</Badge> : <Badge tone='err'>failed</Badge>)}</div>{verifyResult && (<pre className="mt-3 text-xs bg-black/40 border border-white/10 rounded-xl p-3 overflow-auto max-h-56">{typeof verifyResult.data==='string'? verifyResult.data : JSON.stringify(verifyResult,null,2)}</pre>)}</Card><Card title="Quick Text Send"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><Field label="Recipient (MSISDN)"><Input value={sendState.to} onChange={e=>setSendState(s=>({...s,to:e.target.value}))} placeholder="2760xxxxxxx"/></Field><Field label="Message Body"><Textarea value={sendState.body} onChange={e=>setSendState(s=>({...s,body:e.target.value}))}/></Field></div><div className="mt-3 flex items-center gap-3"><Button onClick={doSend} disabled={busy || !sendState.to}>Send</Button>{sendResp && (sendResp.ok ? <Badge tone='ok'>sent</Badge> : <Badge tone='err'>error</Badge>)}</div>{sendResp && (<pre className="mt-3 text-xs bg-black/40 border border-white/10 rounded-xl p-3 overflow-auto max-h-72">{JSON.stringify(sendResp,null,2)}</pre>)}</Card></div>); }
