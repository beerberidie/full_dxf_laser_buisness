import React, { useState } from 'react'
const LS_KEY='wa_connector_settings_v1'
function useCfg(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||{ baseUrl:'http://localhost:8080'} }catch{ return { baseUrl:'http://localhost:8080' }}}
async function jsonFetch(url,opts={}){ const res=await fetch(url,{...opts}); const text=await res.text(); try{ const data=text?JSON.parse(text):null; if(!res.ok) throw new Error(data?JSON.stringify(data):text); return { ok:true, data }; } catch(err){ return { ok:false, error: err.message }} }
function Input(p){ return <input {...p} className='w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 text-sm'/>}
function Textarea(p){ return <textarea {...p} className='w-full rounded-xl bg-black/40 border border-white/10 px-3 py-2 text-sm min-h-[90px]'/>
}
function Button(p){ return <button {...p} className='inline-flex items-center justify-center rounded-xl px-4 py-2 text-sm border border-white/10 bg-white/10 hover:bg-white/20'/>}
export default function MediaTemplateSender(){ const cfg=useCfg(); const base=(cfg.baseUrl||'').replace(/\/$/,''); const [to,setTo]=useState(''); const [link,setLink]=useState(''); const [caption,setCaption]=useState(''); const [tpl,setTpl]=useState({ name:'', lang:'en_US', components:'[]' }); const [resp,setResp]=useState(null); async function sendMedia(type){ const r = await jsonFetch(`${base}/whatsapp/send-media`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to, type, link, caption })}); setResp(r); } async function sendTemplate(){ let components=[]; try{ components = JSON.parse(tpl.components||'[]'); }catch{} const r = await jsonFetch(`${base}/whatsapp/send-template`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ to, template_name: tpl.name, language_code: tpl.lang, components })}); setResp(r);} return (<div className='space-y-6'><div className='rounded-2xl bg-gray-900/70 border border-white/10 p-5'><h3 className='text-lg font-semibold mb-4'>Send Media</h3><div className='grid grid-cols-1 md:grid-cols-2 gap-4'><div><label className='block text-sm mb-1'>To</label><Input value={to} onChange={e=>setTo(e.target.value)} placeholder='2760xxxxxxx'/></div><div><label className='block text-sm mb-1'>Link</label><Input value={link} onChange={e=>setLink(e.target.value)} placeholder='https://...'/></div><div className='md:col-span-2'><label className='block text-sm mb-1'>Caption</label><Textarea value={caption} onChange={e=>setCaption(e.target.value)}/></div></div><div className='flex gap-2 mt-3'><Button onClick={()=>sendMedia('image')}>Send Image</Button><Button onClick={()=>sendMedia('document')}>Send Document</Button><Button onClick={()=>sendMedia('audio')}>Send Audio</Button><Button onClick={()=>sendMedia('video')}>Send Video</Button></div></div><div className='rounded-2xl bg-gray-900/70 border border-white/10 p-5'><h3 className='text-lg font-semibold mb-4'>Send Template</h3><div className='grid grid-cols-1 md:grid-cols-3 gap-4'><div><label className='block text-sm mb-1'>To</label><Input value={to} onChange={e=>setTo(e.target.value)} placeholder='2760xxxxxxx'/></div><div><label className='block text-sm mb-1'>Template Name</label><Input value={tpl.name} onChange={e=>setTpl(s=>({...s,name:e.target.value}))} placeholder='hello_world'/></div><div><label className='block text-sm mb-1'>Language</label><Input value={tpl.lang} onChange={e=>setTpl(s=>({...s,lang:e.target.value}))} placeholder='en_US'/></div></div><div className='mt-3'><label className='block text-sm mb-1'>Components (JSON)</label><Textarea value={tpl.components} onChange={e=>setTpl(s=>({...s,components:e.target.value}))} placeholder='[{"type":"body","parameters":[{"type":"text","text":"Bob"}]}]'/></div><div className='mt-3'><Button onClick={sendTemplate}>Send Template</Button></div>{resp && (<pre className='mt-3 text-xs bg-black/40 border border-white/10 rounded-xl p-3 overflow-auto max-h-72'>{JSON.stringify(resp,null,2)}</pre>)}</div></div>) }
