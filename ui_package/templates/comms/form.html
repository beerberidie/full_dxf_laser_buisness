{% extends "base.html" %}

{% block title %}New Communication{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div class="breadcrumb">
            <a href="{{ url_for('comms.index') }}">Communications</a>
            <span>/</span>
            <span>New</span>
        </div>
        <h1>New Communication</h1>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <form method="POST" class="form">
            <!-- Communication Type -->
            <div class="form-group">
                <label for="comm_type" class="form-label required">Type</label>
                <select 
                    id="comm_type" 
                    name="comm_type" 
                    class="form-control" 
                    required
                    onchange="updateFormFields()"
                >
                    <option value="">Select type...</option>
                    <option value="Email">‚úâÔ∏è Email</option>
                    <option value="WhatsApp">üí¨ WhatsApp</option>
                    <option value="Notification">üîî Notification</option>
                </select>
                <small class="form-help">Type of communication</small>
            </div>

            <!-- Direction -->
            <div class="form-group">
                <label for="direction" class="form-label required">Direction</label>
                <select
                    id="direction"
                    name="direction"
                    class="form-control"
                    required
                    onchange="updateTemplateVisibility()"
                >
                    <option value="">Select direction...</option>
                    <option value="Inbound">üì• Inbound (Received)</option>
                    <option value="Outbound">üì§ Outbound (Sent)</option>
                </select>
                <small class="form-help">Direction of communication</small>
            </div>

            <!-- Template Selector (for Outbound only) -->
            <div class="form-group" id="template_selector_group" style="display: none;">
                <label for="template_id" class="form-label">Use Template (Optional)</label>
                <select
                    id="template_id"
                    name="template_id"
                    class="form-control"
                    onchange="loadTemplate()"
                >
                    <option value="">-- Select a template --</option>
                    <!-- Templates will be loaded via JavaScript -->
                </select>
                <small class="form-help">Select a template to auto-fill subject and message</small>
            </div>

            <!-- Subject -->
            <div class="form-group">
                <label for="subject" class="form-label required">Subject</label>
                <input 
                    type="text" 
                    id="subject" 
                    name="subject" 
                    class="form-control" 
                    required
                    placeholder="e.g., Quote Request for Custom Brackets"
                >
                <small class="form-help">Subject or title of the communication</small>
            </div>

            <!-- From Address -->
            <div class="form-group" id="from_address_group">
                <label for="from_address" class="form-label">From</label>
                <input 
                    type="text" 
                    id="from_address" 
                    name="from_address" 
                    class="form-control" 
                    placeholder="e.g., client@example.com or +27123456789"
                >
                <small class="form-help">Email address or phone number (sender)</small>
            </div>

            <!-- To Address -->
            <div class="form-group" id="to_address_group">
                <label for="to_address" class="form-label">To</label>
                <input 
                    type="text" 
                    id="to_address" 
                    name="to_address" 
                    class="form-control" 
                    placeholder="e.g., client@example.com or +27123456789"
                >
                <small class="form-help">Email address or phone number (recipient)</small>
            </div>

            <!-- Message Body -->
            <div class="form-group">
                <label for="body" class="form-label">Message</label>
                <textarea 
                    id="body" 
                    name="body" 
                    class="form-control" 
                    rows="8"
                    placeholder="Enter the message content..."
                ></textarea>
                <small class="form-help">Full message content</small>
            </div>

            <!-- Status -->
            <div class="form-group">
                <label for="status" class="form-label required">Status</label>
                <select 
                    id="status" 
                    name="status" 
                    class="form-control" 
                    required
                >
                    <option value="Pending">Pending</option>
                    <option value="Sent">Sent</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Read">Read</option>
                    <option value="Failed">Failed</option>
                </select>
                <small class="form-help">Current status of the communication</small>
            </div>

            <!-- Linking Section -->
            <div class="form-section">
                <h3>Link to Client/Project</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="client_id" class="form-label">Client</label>
                        <select 
                            id="client_id" 
                            name="client_id" 
                            class="form-control"
                            onchange="filterProjects()"
                        >
                            <option value="">Select a client...</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}" data-code="{{ client.client_code }}">
                                    {{ client.name }} ({{ client.client_code }})
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-help">Link this communication to a client</small>
                    </div>

                    <div class="form-group">
                        <label for="project_id" class="form-label">Project (optional)</label>
                        <select 
                            id="project_id" 
                            name="project_id" 
                            class="form-control"
                        >
                            <option value="">Select a project...</option>
                            {% for project in projects %}
                                <option value="{{ project.id }}" data-client="{{ project.client_id }}">
                                    {{ project.project_code }} - {{ project.name }}
                                </option>
                            {% endfor %}
                        </select>
                        <small class="form-help">Optionally link to a specific project</small>
                    </div>
                </div>
            </div>

            <!-- Communication Date -->
            <div class="form-group">
                <label for="comm_date" class="form-label">Communication Date</label>
                <input 
                    type="datetime-local" 
                    id="comm_date" 
                    name="comm_date" 
                    class="form-control"
                >
                <small class="form-help">Date and time of the communication (leave blank for now)</small>
            </div>

            <!-- External ID (for integrations) -->
            <div class="form-group">
                <label for="external_id" class="form-label">External ID</label>
                <input 
                    type="text" 
                    id="external_id" 
                    name="external_id" 
                    class="form-control" 
                    placeholder="e.g., message-id from email system"
                >
                <small class="form-help">External system ID (for integrations)</small>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    Create Communication
                </button>
                <a href="{{ url_for('comms.index') }}" class="btn btn-ghost">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<style>
.form-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e0e0e0;
}

.form-section h3 {
    margin-bottom: 1rem;
    font-size: 1.25rem;
    color: #333;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Template data cache
let templatesCache = [];

// Load templates on page load
document.addEventListener('DOMContentLoaded', function() {
    loadTemplates();
});

function loadTemplates() {
    // Fetch active templates from the server
    fetch('/comms/templates/api/active')
        .then(response => response.json())
        .then(data => {
            templatesCache = data;
            populateTemplateSelector();
        })
        .catch(error => {
            console.error('Failed to load templates:', error);
        });
}

function populateTemplateSelector() {
    const select = document.getElementById('template_id');

    // Clear existing options (except the first one)
    while (select.options.length > 1) {
        select.remove(1);
    }

    // Add templates
    templatesCache.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.name;
        option.setAttribute('data-subject', template.subject_template);
        option.setAttribute('data-body', template.body_template);
        select.appendChild(option);
    });
}

function updateTemplateVisibility() {
    const direction = document.getElementById('direction').value;
    const templateGroup = document.getElementById('template_selector_group');

    // Show template selector only for Outbound communications
    if (direction === 'Outbound') {
        templateGroup.style.display = 'block';
    } else {
        templateGroup.style.display = 'none';
        document.getElementById('template_id').value = '';
    }
}

function loadTemplate() {
    const select = document.getElementById('template_id');
    const selectedOption = select.options[select.selectedIndex];

    if (!selectedOption || !selectedOption.value) {
        return;
    }

    const subject = selectedOption.getAttribute('data-subject');
    const body = selectedOption.getAttribute('data-body');

    // Get client and project IDs for rendering
    const clientId = document.getElementById('client_id').value;
    const projectId = document.getElementById('project_id').value;

    // Render template with data
    renderTemplate(selectedOption.value, clientId, projectId)
        .then(data => {
            if (data.success) {
                document.getElementById('subject').value = data.subject;
                document.getElementById('body').value = data.body;
            } else {
                // Fallback to raw template
                document.getElementById('subject').value = subject;
                document.getElementById('body').value = body;
            }
        })
        .catch(error => {
            console.error('Template rendering failed:', error);
            // Fallback to raw template
            document.getElementById('subject').value = subject;
            document.getElementById('body').value = body;
        });
}

function renderTemplate(templateId, clientId, projectId) {
    const formData = new FormData();
    if (clientId) formData.append('client_id', clientId);
    if (projectId) formData.append('project_id', projectId);

    return fetch(`/comms/templates/${templateId}/preview`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json());
}

function updateFormFields() {
    const commType = document.getElementById('comm_type').value;
    const fromGroup = document.getElementById('from_address_group');
    const toGroup = document.getElementById('to_address_group');
    const fromInput = document.getElementById('from_address');
    const toInput = document.getElementById('to_address');

    if (commType === 'Email') {
        fromInput.placeholder = 'e.g., client@example.com';
        toInput.placeholder = 'e.g., info@laseros.local';
    } else if (commType === 'WhatsApp') {
        fromInput.placeholder = 'e.g., +27123456789';
        toInput.placeholder = 'e.g., +27987654321';
    } else if (commType === 'Notification') {
        fromInput.placeholder = 'System or user name';
        toInput.placeholder = 'Recipient name';
    }
}

function filterProjects() {
    const clientId = document.getElementById('client_id').value;
    const projectSelect = document.getElementById('project_id');
    const options = projectSelect.querySelectorAll('option');
    
    options.forEach(option => {
        if (option.value === '') {
            option.style.display = 'block';
            return;
        }
        
        const projectClientId = option.getAttribute('data-client');
        if (!clientId || projectClientId === clientId) {
            option.style.display = 'block';
        } else {
            option.style.display = 'none';
        }
    });
    
    // Reset project selection if it doesn't match the client
    const selectedOption = projectSelect.options[projectSelect.selectedIndex];
    if (selectedOption && selectedOption.getAttribute('data-client') !== clientId && clientId !== '') {
        projectSelect.value = '';
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFormFields();
    filterProjects();
});
</script>
{% endblock %}

