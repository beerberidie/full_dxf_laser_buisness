{% extends "base.html" %}

{% block title %}{{ client.client_code }} - {{ client.name }}{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <div class="breadcrumb">
            <a href="{{ url_for('clients.list_clients') }}">Clients</a>
            <span>/</span>
            <span>{{ client.client_code }}</span>
        </div>
        <h1>{{ client.name }}</h1>
        <p class="text-muted">{{ client.client_code }}</p>
    </div>
    <div class="page-actions">
        {% if current_user.has_role('admin') or current_user.has_role('manager') %}
        <a href="{{ url_for('clients.edit', id=client.id) }}" class="btn btn-secondary">
            Edit Client
        </a>
        <button onclick="confirmDelete()" class="btn btn-danger">
            Delete Client
        </button>
        {% endif %}
    </div>
</div>

<!-- Client Information -->
<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <h2>Contact Information</h2>
        </div>
        <div class="card-body">
            <dl class="detail-list">
                <dt>Contact Person</dt>
                <dd>{{ client.contact_person or '-' }}</dd>
                
                <dt>Email</dt>
                <dd>
                    {% if client.email %}
                        <a href="mailto:{{ client.email }}">{{ client.email }}</a>
                    {% else %}
                        -
                    {% endif %}
                </dd>
                
                <dt>Phone</dt>
                <dd>
                    {% if client.phone %}
                        <a href="tel:{{ client.phone }}">{{ client.phone }}</a>
                    {% else %}
                        -
                    {% endif %}
                </dd>
                
                <dt>Address</dt>
                <dd>
                    {% if client.address %}
                        <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">{{ client.address }}</pre>
                    {% else %}
                        -
                    {% endif %}
                </dd>
            </dl>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>Metadata</h2>
        </div>
        <div class="card-body">
            <dl class="detail-list">
                <dt>Client Code</dt>
                <dd><code>{{ client.client_code }}</code></dd>
                
                <dt>Created</dt>
                <dd>{{ client.created_at|datetime }}</dd>
                
                <dt>Last Updated</dt>
                <dd>{{ client.updated_at|datetime }}</dd>
            </dl>
        </div>
    </div>
</div>

<!-- Notes -->
{% if client.notes %}
<div class="card">
    <div class="card-header">
        <h2>Notes</h2>
    </div>
    <div class="card-body">
        <pre style="white-space: pre-wrap; font-family: inherit;">{{ client.notes }}</pre>
    </div>
</div>
{% endif %}

<!-- Projects -->
<div class="card">
    <div class="card-header">
        <h2>Projects ({{ projects|length }})</h2>
        <a href="{{ url_for('projects.new_project') }}?client_id={{ client.id }}" class="btn btn-sm btn-primary">
            + New Project
        </a>
    </div>
    <div class="card-body">
        {% if projects %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Material</th>
                        <th>Quoted Price</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr>
                        <td>
                            <a href="{{ url_for('projects.detail', id=project.id) }}" class="link-primary">
                                {{ project.project_code }}
                            </a>
                        </td>
                        <td>{{ project.name }}</td>
                        <td>
                            <span class="badge badge-{{ project.status|lower|replace(' ', '-') }}">
                                {{ project.status }}
                            </span>
                            {% if project.is_overdue %}
                                <span class="badge badge-danger" title="Overdue">⚠️</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if project.material_type %}
                                {{ project.material_type }}
                                {% if project.material_thickness %}
                                    ({{ project.material_thickness }}mm)
                                {% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if project.quoted_price %}
                                R{{ "%.2f"|format(project.quoted_price) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ project.created_at|date }}</td>
                        <td>
                            <div class="btn-group">
                                <a href="{{ url_for('projects.detail', id=project.id) }}" class="btn btn-sm btn-ghost">
                                    View
                                </a>
                                <a href="{{ url_for('projects.edit', id=project.id) }}" class="btn btn-sm btn-ghost">
                                    Edit
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="empty-state-sm">
                <p>No projects found for this client.</p>
                <p>Get started by creating a new project.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Activity Log -->
<div class="card">
    <div class="card-header">
        <h2>Activity Log</h2>
    </div>
    <div class="card-body">
        {% if activities %}
            <div class="activity-log">
                {% for activity in activities %}
                <div class="activity-item">
                    <div class="activity-badge">
                        <span class="badge badge-{{ activity.action.lower() }}">
                            {{ activity.action }}
                        </span>
                    </div>
                    <div class="activity-content">
                        <p class="activity-user">{{ activity.user }}</p>
                        <p class="activity-time">{{ activity.created_at|datetime }}</p>
                        {% if activity.details %}
                            <pre class="activity-details">{{ activity.details }}</pre>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-muted">No activity recorded.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete this client? This action cannot be undone.')) {
        // Create and submit a form for DELETE request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("clients.delete", id=client.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}

