{% extends "base.html" %}

{% block title %}{{ template.name }} - {{ company_name }}{% endblock %}

{% block content %}
<div class="page-header">
    <h1>{{ template.name }}</h1>
    <div class="page-actions">
        {% if current_user.has_role('admin') or current_user.has_role('manager') %}
        <a href="{{ url_for('templates.edit_template', template_id=template.id) }}" class="btn btn-primary">
            <i class="icon">‚úé</i> Edit
        </a>
        <form method="post" action="{{ url_for('templates.toggle_active', template_id=template.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-secondary">
                {% if template.is_active %}Deactivate{% else %}Activate{% endif %}
            </button>
        </form>
        <form method="post" action="{{ url_for('templates.delete_template', template_id=template.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this template?');">
            <button type="submit" class="btn btn-danger">
                <i class="icon">üóë</i> Delete
            </button>
        </form>
        {% endif %}
        <a href="{{ url_for('templates.list_templates') }}" class="btn btn-secondary">
            <i class="icon">‚Üê</i> Back
        </a>
    </div>
</div>

<!-- Template Info -->
<div class="detail-container">
    <div class="detail-section">
        <h2>Template Information</h2>
        
        <div class="detail-grid">
            <div class="detail-item">
                <label>Name:</label>
                <div class="detail-value">{{ template.name }}</div>
            </div>
            
            <div class="detail-item">
                <label>Type:</label>
                <div class="detail-value">
                    <span class="badge badge-info">
                        {{ template.template_type.replace('_', ' ').title() }}
                    </span>
                </div>
            </div>
            
            <div class="detail-item">
                <label>Status:</label>
                <div class="detail-value">
                    {% if template.is_active %}
                    <span class="badge badge-success">Active</span>
                    {% else %}
                    <span class="badge badge-secondary">Inactive</span>
                    {% endif %}
                </div>
            </div>
            
            {% if template.description %}
            <div class="detail-item full-width">
                <label>Description:</label>
                <div class="detail-value">{{ template.description }}</div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Template Content -->
    <div class="detail-section">
        <h2>Template Content</h2>
        
        <div class="template-content">
            <div class="content-item">
                <label>Subject Template:</label>
                <div class="template-code">{{ template.subject_template }}</div>
            </div>
            
            <div class="content-item">
                <label>Body Template:</label>
                <div class="template-code multiline">{{ template.body_template }}</div>
            </div>
        </div>
    </div>

    <!-- Preview Section -->
    <div class="detail-section">
        <h2>Preview Template</h2>
        <p class="text-muted">Select a client and/or project to preview the template with real data</p>
        
        <form id="previewForm" class="preview-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="client_id">Client (Optional):</label>
                    <select id="client_id" name="client_id">
                        <option value="">Select a client...</option>
                        <!-- Will be populated via JavaScript or server-side -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="project_id">Project (Optional):</label>
                    <select id="project_id" name="project_id">
                        <option value="">Select a project...</option>
                        <!-- Will be populated via JavaScript or server-side -->
                    </select>
                </div>
                
                <div class="form-group">
                    <button type="button" onclick="previewTemplate()" class="btn btn-primary">
                        Preview
                    </button>
                </div>
            </div>
        </form>
        
        <div id="previewResult" class="preview-result" style="display: none;">
            <h3>Preview Result</h3>
            <div class="preview-email">
                <div class="preview-subject">
                    <strong>Subject:</strong>
                    <div id="previewSubject" class="preview-text"></div>
                </div>
                <div class="preview-body">
                    <strong>Body:</strong>
                    <div id="previewBody" class="preview-text"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Metadata -->
    <div class="detail-section">
        <h2>Metadata</h2>
        
        <div class="detail-grid">
            <div class="detail-item">
                <label>Created By:</label>
                <div class="detail-value">{{ template.created_by.username if template.created_by else 'System' }}</div>
            </div>
            
            <div class="detail-item">
                <label>Created:</label>
                <div class="detail-value">{{ template.created_at.strftime('%Y-%m-%d %H:%M') if template.created_at else '-' }}</div>
            </div>
            
            <div class="detail-item">
                <label>Last Updated:</label>
                <div class="detail-value">{{ template.updated_at.strftime('%Y-%m-%d %H:%M') if template.updated_at else '-' }}</div>
            </div>
        </div>
    </div>
</div>

<script>
function previewTemplate() {
    const clientId = document.getElementById('client_id').value;
    const projectId = document.getElementById('project_id').value;
    
    // Create form data
    const formData = new FormData();
    if (clientId) formData.append('client_id', clientId);
    if (projectId) formData.append('project_id', projectId);
    
    // Send preview request
    fetch('{{ url_for("templates.preview_template", template_id=template.id) }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show preview result
            document.getElementById('previewSubject').textContent = data.subject;
            document.getElementById('previewBody').textContent = data.body;
            document.getElementById('previewResult').style.display = 'block';
        } else {
            alert('Preview failed: ' + data.error);
        }
    })
    .catch(error => {
        alert('Preview failed: ' + error);
    });
}

// Load clients and projects for preview
document.addEventListener('DOMContentLoaded', function() {
    // Load clients
    fetch('/api/clients')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('client_id');
            data.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.client_code} - ${client.name}`;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Failed to load clients:', error));
    
    // Load projects
    fetch('/api/projects')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('project_id');
            data.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = `${project.project_code} - ${project.project_name}`;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Failed to load projects:', error));
});
</script>

<style>
.detail-container {
    max-width: 1200px;
}

.detail-section {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.detail-section h2 {
    margin-top: 0;
    margin-bottom: 1.5rem;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 0.5rem;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.detail-item.full-width {
    grid-column: 1 / -1;
}

.detail-item label {
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
}

.detail-value {
    color: #212529;
    font-size: 1rem;
}

.template-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.content-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.content-item label {
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
}

.template-code {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    color: #212529;
}

.template-code.multiline {
    white-space: pre-wrap;
    word-wrap: break-word;
}

.preview-form {
    margin-bottom: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr auto;
    gap: 1rem;
    align-items: end;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-group label {
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
}

.form-group select {
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 0.875rem;
}

.preview-result {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #dee2e6;
}

.preview-result h3 {
    margin-top: 0;
    margin-bottom: 1rem;
    color: #333;
}

.preview-email {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
}

.preview-subject,
.preview-body {
    margin-bottom: 1rem;
}

.preview-subject strong,
.preview-body strong {
    display: block;
    margin-bottom: 0.5rem;
    color: #495057;
}

.preview-text {
    background: white;
    padding: 1rem;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    border-radius: 4px;
    text-transform: uppercase;
}

.badge-success {
    background: #28a745;
    color: white;
}

.badge-secondary {
    background: #6c757d;
    color: white;
}

.badge-info {
    background: #17a2b8;
    color: white;
}
</style>
{% endblock %}

